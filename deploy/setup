#!/usr/bin/env bash

# This script is idempotent.

set -euxo pipefail

CHAIN=$1
DOMAIN=$2

export DEBIAN_FRONTEND=noninteractive

touch ~/.hushlogin

hostnamectl set-hostname $DOMAIN

apt-get install --yes \
  acl \
  autoconf \
  automake \
  build-essential \
  clang \
  cmake \
  curl \
  libboost-dev \
  libevent-dev \
  libpq-dev \
  libsqlite3-dev\
  libssl-dev \
  libtool \
  libzmq3-dev \
  locales-all \
  pkg-config \
  pkgconf \
  postgresql \
  postgresql-contrib \
  python3 \
  ufw \
  vim \
  yasm

apt-get remove --yes --auto-remove

ufw default allow outgoing
ufw default deny incoming

ufw allow http
ufw allow https
ufw allow ssh
ufw allow 42069

case $CHAIN in
  main)
    ufw allow 8333
    ;;
  regtest)
    ufw allow 18444
    ;;
  signet)
    # Local signet only
    # ufw allow 38333
    ;;
  test)
    ufw allow 18333
    ;;
  testnet4)
    ufw allow 48333
    ;;
  *)
    echo "Unknown chain: $CHAIN"
    exit 1
    ;;
esac

mkdir -p \
  /etc/systemd/system/bitcoind.service.d \
  /etc/systemd/system/ckpool.service.d \
  /etc/systemd/system/para.service.d

OVERRIDE=/etc/systemd/system/ckpool.service.d/override.conf

echo '[Service]' > $OVERRIDE
echo "Environment=CHAIN=$CHAIN" >> $OVERRIDE

cp $OVERRIDE /etc/systemd/system/bitcoind.service.d/override.conf
cp $OVERRIDE /etc/systemd/system/para.service.d/override.conf

sed -i -E 's/#?PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sshd -t
systemctl restart sshd

ufw --force enable

if ! which bitcoind; then
  ./bin/install-bitcoin-core-linux
fi

bitcoind --version

rm -f /var/lib/bitcoind/settings.json

id --user bitcoin || useradd --system bitcoin
id --user ckpool || useradd --system ckpool
