<div class=grid>
  <div class=column>
    <h2>Upstream</h2>
    <div class=row><span>Endpoint</span><span id=upstream_endpoint></span></div>
    <div class=row><span>Status</span><span id=upstream_status></span></div>
    <div class=row><span>Username</span><span id=upstream_username class=copyable></span></div>
    <div class=row><span>Extranonce1</span><span id=upstream_enonce1></span></div>
    <div class=row><span>Extranonce2 Size</span><span id=upstream_enonce2_size></span></div>
    <div class=row><span>Version Mask</span><span id=upstream_version_mask></span></div>
    <h3>Shares</h3>
    <div class=row><span>Accepted</span><span id=upstream_accepted></span></div>
    <div class=row><span>Rejected</span><span id=upstream_rejected></span></div>
  </div>

  <div class=column>
    <h2>Downstream</h2>
    <div class=row><span>Users</span><span id=users></span></div>
    <div class=row><span>Workers</span><span id=workers></span></div>
    <div class=row><span>Connections</span><span id=connections></span></div>
    <div class=row><span>Hashrate</span><span id=hashrate_1m></span></div>
    <div class=row><span>SPS</span><span id=sps></span></div>
    <div class=row><span>Uptime</span><span><span id=uptime_secs></span>s</span></div>
    <h3>Shares</h3>
    <div class=row><span>Accepted</span><span id=accepted></span></div>
    <div class=row><span>Rejected</span><span id=rejected></span></div>
    <div class=row><span>Best</span><span id=best_ever></span></div>
    <div class=row><span>Last</span><span><span id=last_share></span>s ago</span></div>
  </div>

  <div class=column>
    <h2>Bitcoin</h2>
    <div class=row><span>Block Height</span><span id=btc_height></span></div>
    <div class=row><span>Network Difficulty</span><span id=network_difficulty></span></div>
  </div>

  <div class=column>
    <h2>System</h2>
    <div class=row><span>CPU</span><span><span id=cpu_usage_percent></span>%</span></div>
    <div class=row><span>Memory</span><span><span id=memory_usage_percent></span>%</span></div>
    <div class=row><span>Disk</span><span><span id=disk_usage_percent></span>%</span></div>
    <div class=row><span>Uptime</span><span><span id=uptime></span>s</span></div>
  </div>
</div>

<div id=logs></div>

<script>
async function refresh() {
  try {
    const [proxyData, systemData, bitcoinData] = await Promise.all([
      fetch('/api/proxy/status').then(r => r.json()).catch(() => ({})),
      fetch('/api/system/status').then(r => r.json()).catch(() => ({})),
      fetch('/api/bitcoin/status').then(r => r.json()).catch(() => ({}))
    ]);
    const u = proxyData.upstream_username;
    const upstream_username = u?.length > 15 ? u.slice(0,6) + '...' + u.slice(-6) : u;
    const merged = {...proxyData, ...systemData, ...bitcoinData, sps: proxyData.sps_1m?.toFixed(2), upstream_status: proxyData.upstream_connected ? 'Connected' : 'Disconnected', upstream_username};

    Object.keys(merged).forEach(key => {
      const el = document.getElementById(key);
      if (el) el.textContent = merged[key] != null ? merged[key].toLocaleString() : '-';
    });

    document.getElementById('upstream_status').className = proxyData.upstream_status.toLowerCase();

    const uel = document.getElementById('upstream_username');
    uel.dataset.full = u;
    uel.title = u;
  } catch (e) {}
}
startPolling(refresh);
connectWs();
copyOnClick('upstream_username');
</script>
