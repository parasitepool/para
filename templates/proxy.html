<div class=grid>
  <div class=column>
    <h2>Upstream</h2>
    <div class=row><span>Endpoint</span><span id=upstream_endpoint></span></div>
    <div class=row><span>Status</span><span id=upstream_status></span></div>
    <div class=row><span>Username</span><span id=upstream_username class=copyable></span></div>
    <div class=row><span>Difficulty</span><span id=upstream_difficulty class=copyable></span></div>
    <div class=row><span>Extranonce1</span><span id=upstream_enonce1></span></div>
    <div class=row><span>Extranonce2 Size</span><span id=upstream_enonce2_size></span></div>
    <div class=row><span>Version Mask</span><span id=upstream_version_mask></span></div>
    <h3>Shares</h3>
    <div class=row><span>Accepted</span><span id=upstream_accepted></span></div>
    <div class=row><span>Rejected</span><span id=upstream_rejected></span></div>
    <div class=row><span>Filtered</span><span id=upstream_filtered></span></div>
    <div class=row><span>Forward %</span><span id=forward_ratio></span></div>
  </div>

  <div class=column>
    <h2>Downstream</h2>
    <div class=row><span>Endpoint</span><span id=endpoint></span></div>
    <div class=row><span>Users</span><span id=users></span></div>
    <div class=row><span>Workers</span><span id=workers></span></div>
    <div class=row><span>Connections</span><span id=connections></span></div>
    <div class=row><span>Hashrate (5m)</span><span id=hashrate_5m></span></div>
    <div class=row><span>SPS (5m)</span><span id=sps_5m></span></div>
    <div class=row><span>Uptime</span><span><span id=uptime_secs></span>s</span></div>
    <h3>Shares</h3>
    <div class=row><span>Accepted</span><span id=accepted></span></div>
    <div class=row><span>Rejected</span><span id=rejected></span></div>
    <div class=row><span>Best</span><span id=best_ever class=copyable></span></div>
    <div class=row><span>Last</span><span><span id=last_share></span>s ago</span></div>
  </div>

  <div class=column>
    <h2>Bitcoin</h2>
    <div class=row><span>Block Height</span><span id=btc_height></span></div>
    <div class=row><span>Network Difficulty</span><span id=network_difficulty class=copyable></span></div>
  </div>

  <div class=column>
    <h2>System</h2>
    <div class=row><span>CPU</span><span><span id=cpu_usage_percent></span>%</span></div>
    <div class=row><span>Memory</span><span><span id=memory_usage_percent></span>%</span></div>
    <div class=row><span>Disk</span><span><span id=disk_usage_percent></span>%</span></div>
    <div class=row><span>Uptime</span><span><span id=uptime></span>s</span></div>
  </div>
</div>

<button id=log-show>Show Logs</button>
<div id=log-controls style="display:none">
  <input type=search id=log-filter placeholder="Filter logs..." autocomplete=off data-1p-ignore data-lpignore=true data-bwignore=true>
  <button id=log-pause>Pause</button>
  <button id=log-clear>Clear</button>
  <button id=log-hide>Hide</button>
</div>
<div id=logs style="display:none"></div>

<script>
async function refresh() {
  try {
    const [proxyData, systemData, bitcoinData] = await Promise.all([
      fetch('/api/proxy/status').then(r => r.json()).catch(() => ({})),
      fetch('/api/system/status').then(r => r.json()).catch(() => ({})),
      fetch('/api/bitcoin/status').then(r => r.json()).catch(() => ({}))
    ]);

    const u = proxyData.upstream_username;
    const upstream_username = u?.length > 15 ? u.slice(0,6) + '...' + u.slice(-6) : u;
    const forwarded = (proxyData.upstream_accepted || 0) + (proxyData.upstream_rejected || 0);
    const total = forwarded + (proxyData.upstream_filtered || 0);
    const forward_ratio = total > 0 ? fmt2t((forwarded / total) * 100) + '%' : '-';
    const upstream_difficulty = formatDifficulty(proxyData.upstream_difficulty);
    const network_difficulty = formatDifficulty(bitcoinData.network_difficulty);
    const best_ever = formatDifficulty(proxyData.best_ever);

    setTextIfNotHovering('upstream_endpoint', proxyData.upstream_endpoint);
    setTextIfNotHovering('upstream_status', proxyData.upstream_connected ? 'Connected' : 'Disconnected');
    setTextIfNotHovering('upstream_username', upstream_username);
    setTextIfNotHovering('upstream_difficulty', upstream_difficulty);
    setTextIfNotHovering('upstream_enonce1', proxyData.upstream_enonce1);
    setTextIfNotHovering('upstream_enonce2_size', proxyData.upstream_enonce2_size);
    setTextIfNotHovering('upstream_version_mask', proxyData.upstream_version_mask);
    setTextIfNotHovering('upstream_accepted', proxyData.upstream_accepted);
    setTextIfNotHovering('upstream_rejected', proxyData.upstream_rejected);
    setTextIfNotHovering('upstream_filtered', proxyData.upstream_filtered);
    setTextIfNotHovering('forward_ratio', forward_ratio);
    setTextIfNotHovering('endpoint', proxyData.endpoint);
    setTextIfNotHovering('users', proxyData.users);
    setTextIfNotHovering('workers', proxyData.workers);
    setTextIfNotHovering('connections', proxyData.connections);
    setTextIfNotHovering('hashrate_5m', proxyData.hashrate_5m, formatHashrate);
    setTextIfNotHovering('sps_5m', proxyData.sps_5m, fmt2t);
    setTextIfNotHovering('uptime_secs', proxyData.uptime_secs);
    setTextIfNotHovering('accepted', proxyData.accepted);
    setTextIfNotHovering('rejected', proxyData.rejected);
    setTextIfNotHovering('last_share', proxyData.last_share);
    setTextIfNotHovering('btc_height', bitcoinData.height);
    setTextIfNotHovering('network_difficulty', network_difficulty);
    setTextIfNotHovering('cpu_usage_percent', systemData.cpu_usage_percent, fmt2t);
    setTextIfNotHovering('memory_usage_percent', systemData.memory_usage_percent, fmt2t);
    setTextIfNotHovering('disk_usage_percent', systemData.disk_usage_percent, fmt2t);
    setTextIfNotHovering('uptime', systemData.uptime);
    setTextIfNotHovering('best_ever', best_ever);

    const statusEl = document.getElementById('upstream_status');
    if (statusEl) statusEl.className = proxyData.upstream_connected ? 'connected' : 'disconnected';

    const uel = document.getElementById('upstream_username');
    if (uel) {
      uel.dataset.full = u;
      uel.dataset.formatted = upstream_username;
    }

    const del = document.getElementById('upstream_difficulty');
    if (del) {
      del.dataset.full = String(proxyData.upstream_difficulty);
      del.dataset.formatted = upstream_difficulty;
    }

    const nel = document.getElementById('network_difficulty');
    if (nel) {
      nel.dataset.full = String(bitcoinData.network_difficulty);
      nel.dataset.formatted = network_difficulty;
    }

    const bel = document.getElementById('best_ever');
    if (bel) {
      bel.dataset.full = String(proxyData.best_ever);
      bel.dataset.formatted = best_ever;
    }
  } catch (e) { console.error('refresh error:', e); }
}
startPolling(refresh);
connectWs();
setupLogToggle();
setupCopyable('upstream_username');
setupCopyable('upstream_difficulty');
setupCopyable('network_difficulty');
setupCopyable('best_ever');
</script>
