<!doctype html>
<html lang=en>
<head>
  <meta charset=utf-8>
  <meta name=viewport content='width=device-width,initial-scale=1.0'>
  <title>Proxy</title>
  <link rel=icon href=/static/parasite.svg type=image/x-icon size=16x16>
  <style>
    body { font: clamp(14px, 1.5vw, 18px)/1.6 monospace; margin: 30px; background: #111; color: #eee; }
    h1 { text-align: center; margin-bottom: 40px; font-size: 1.55em; }
    .logo { display: block; margin: 0 auto 20px; height: 4em; }
    .columns { display: flex; gap: 60px; }
    .column { border: 1px solid #444; padding: 20px 30px; width: 500px; box-sizing: border-box; }
    .column h2 { margin: 0 0 15px; font-size: 1.22em; text-align: center; }
    .column h3 { margin: 15px 0 10px; font-size: 1.11em; color: #888; border-top: 1px solid #444; padding-top: 15px; text-align: center; }
    .row { display: flex; justify-content: space-between; }
    .connected { color: #4f4; }
    .disconnected { color: #f44; }
    #upstream_username { cursor: pointer; }
    #upstream_username:hover { text-decoration: underline; }
    .wrapper { width: fit-content; margin: 0 auto; }
    #logs {
      margin-top: 40px;
      height: 300px;
      overflow-y: auto;
      background: #0a0a0a;
      border: 1px solid #444;
      padding: 10px;
      font-size: 0.67em;
      box-sizing: border-box;
    }
    #logs div { white-space: pre-wrap; word-break: break-all; }
    #logs::-webkit-scrollbar { width: 8px; }
    #logs::-webkit-scrollbar-track { background: #1a1a1a; }
    #logs::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    #logs::-webkit-scrollbar-thumb:hover { background: #666; }
    #logs { scrollbar-color: #444 #1a1a1a; }
    .log-error { color: #f55; }
    .log-warn { color: #fa0; }
    .log-info { color: #4f4; }
    .log-debug { color: #88f; }
    .log-trace { color: #888; }
    @media (max-width: 1140px) {
      body { margin: 20px; }
      .wrapper { width: auto; }
      .columns { flex-direction: column; gap: 30px; align-items: center; }
      .column { width: 100%; max-width: 500px; }
      #logs { max-width: 500px; margin-left: auto; margin-right: auto; }
    }
    @media (max-width: 560px) {
      body { margin: 10px; }
      .column { padding: 15px 20px; }
    }
  </style>
</head>
<body>
<img src=/static/parasite.svg alt="" class=logo>
<h1>Parasite Proxy</h1>
<div class=wrapper>
<div class=columns>
  <div class=column>
    <h2>Upstream</h2>
    <div class=row><span>Endpoint</span><span id=upstream_endpoint></span></div>
    <div class=row><span>Status</span><span id=upstream_status></span></div>
    <div class=row><span>Username</span><span id=upstream_username></span></div>
    <div class=row><span>Extranonce1</span><span id=upstream_enonce1></span></div>
    <div class=row><span>Extranonce2 Size</span><span id=upstream_enonce2_size></span></div>
    <div class=row><span>Version Mask</span><span id=upstream_version_mask></span></div>
    <h3>Shares</h3>
    <div class=row><span>Accepted</span><span id=upstream_accepted></span></div>
    <div class=row><span>Rejected</span><span id=upstream_rejected></span></div>
  </div>

  <div class=column>
    <h2>Downstream</h2>
    <div class=row><span>Users</span><span id=users></span></div>
    <div class=row><span>Workers</span><span id=workers></span></div>
    <div class=row><span>Connections</span><span id=connections></span></div>
    <div class=row><span>Hashrate</span><span id=hashrate></span></div>
    <div class=row><span>SPS</span><span id=sps></span></div>
    <div class=row><span>Uptime</span><span id=uptime></span></div>
    <h3>Shares</h3>
    <div class=row><span>Accepted</span><span id=accepted></span></div>
    <div class=row><span>Rejected</span><span id=rejected></span></div>
    <div class=row><span>Best</span><span id=best_ever></span></div>
    <div class=row><span>Last</span><span id=last_share></span></div>
  </div>
</div>

<div id=logs></div>
</div>

<script>
async function refresh() {
  try {
    const r = await fetch('/api/proxy/status');
    if (!r.ok) return;
    const s = await r.json();
    document.getElementById('users').textContent = s.users;
    document.getElementById('workers').textContent = s.workers;
    document.getElementById('connections').textContent = s.connections;
    document.getElementById('uptime').textContent = s.uptime_secs + 's';
    document.getElementById('hashrate').textContent = s.hashrate_1m;
    document.getElementById('sps').textContent = s.sps_1m.toFixed(2);
    document.getElementById('accepted').textContent = s.accepted;
    document.getElementById('rejected').textContent = s.rejected;
    document.getElementById('best_ever').textContent = s.best_ever ?? '-';
    document.getElementById('last_share').textContent = s.last_share != null ? s.last_share + 's ago' : '-';
    document.getElementById('upstream_endpoint').textContent = s.upstream_endpoint;
    const st = document.getElementById('upstream_status');
    st.textContent = s.upstream_connected ? 'Connected' : 'Disconnected';
    st.className = s.upstream_connected ? 'connected' : 'disconnected';
    const u = s.upstream_username;
    const uel = document.getElementById('upstream_username');
    uel.textContent = u.length <= 15 ? u : u.slice(0,6) + '...' + u.slice(-6);
    uel.dataset.full = u;
    uel.title = u;
    document.getElementById('upstream_enonce1').textContent = s.upstream_enonce1;
    document.getElementById('upstream_enonce2_size').textContent = s.upstream_enonce2_size;
    document.getElementById('upstream_version_mask').textContent = s.upstream_version_mask ?? '-';
    document.getElementById('upstream_accepted').textContent = s.upstream_accepted;
    document.getElementById('upstream_rejected').textContent = s.upstream_rejected;
  } catch (e) {}
}
refresh();
setInterval(refresh, 1000);

const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
const logsEl = document.getElementById('logs');
function connectWs() {
  const ws = new WebSocket(`${protocol}//${location.host}/ws/logs`);
  ws.onmessage = (e) => {
    const [level, ...rest] = e.data.split('\t');
    const line = document.createElement('div');
    const lvl = document.createElement('span');
    lvl.className = 'log-' + level.trim().toLowerCase();
    lvl.textContent = level;
    line.appendChild(lvl);
    line.appendChild(document.createTextNode(' ' + rest.join('\t')));
    logsEl.appendChild(line);
    while (logsEl.children.length > 100) {
      logsEl.removeChild(logsEl.firstChild);
    }
    logsEl.scrollTop = logsEl.scrollHeight;
  };
  ws.onclose = () => setTimeout(connectWs, 2000);
}
connectWs();

document.getElementById('upstream_username').addEventListener('click', function() {
  const full = this.dataset.full;
  if (!full) return;
  navigator.clipboard.writeText(full).then(() => {
    const prev = this.textContent;
    this.textContent = 'Copied!';
    setTimeout(() => { this.textContent = prev; }, 1000);
  });
});
</script>
</body>
</html>
