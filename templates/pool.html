<div class=grid>
  <div class="column column-full">
    <h2>Stats</h2>
    <div class=row><span>Users</span><span id=users></span></div>
    <div class=row><span>Workers</span><span id=workers></span></div>
    <div class=row><span>Connections</span><span id=connections></span></div>
    <div class=row><span>Hashrate (5m)</span><span id=hashrate_5m></span></div>
    <div class=row><span>SPS (5m)</span><span id=sps_5m></span></div>
    <div class=row><span>Uptime</span><span><span id=uptime_secs></span>s</span></div>
    <div class=row><span>Blocks</span><span id=blocks></span></div>
    <h3>Shares</h3>
    <div class=row><span>Accepted</span><span id=accepted></span></div>
    <div class=row><span>Rejected</span><span id=rejected></span></div>
    <div class=row><span>Best</span><span id=best_ever class=copyable></span></div>
    <div class=row><span>Last</span><span><span id=last_share></span>s ago</span></div>
  </div>

  <div class=column>
    <h2>Bitcoin</h2>
    <div class=row><span>Block Height</span><span id=btc_height></span></div>
    <div class=row><span>Network Difficulty</span><span id=network_difficulty class=copyable></span></div>
  </div>

  <div class=column>
    <h2>System</h2>
    <div class=row><span>CPU</span><span><span id=cpu_usage_percent></span>%</span></div>
    <div class=row><span>Memory</span><span><span id=memory_usage_percent></span>%</span></div>
    <div class=row><span>Disk</span><span><span id=disk_usage_percent></span>%</span></div>
    <div class=row><span>Uptime</span><span><span id=uptime></span>s</span></div>
  </div>
</div>

<button id=log-show>Show Logs</button>
<div id=log-controls style="display:none">
  <input type=search id=log-filter placeholder="Filter logs..." autocomplete=off data-1p-ignore data-lpignore=true data-bwignore=true>
  <button id=log-pause>Pause</button>
  <button id=log-clear>Clear</button>
  <button id=log-hide>Hide</button>
</div>
<div id=logs style="display:none"></div>

<script>
function fmt2(n) {
  return n != null ? n.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-';
}

async function refresh() {
  try {
    const [poolData, systemData, bitcoinData] = await Promise.all([
      fetch('/api/pool/status').then(r => r.json()).catch(() => ({})),
      fetch('/api/system/status').then(r => r.json()).catch(() => ({})),
      fetch('/api/bitcoin/status').then(r => r.json()).catch(() => ({}))
    ]);
    const network_difficulty = formatDifficulty(bitcoinData.network_difficulty);
    const btc_height = bitcoinData.height;
    const best_ever = formatDifficulty(poolData.best_ever);
    const hashrate_5m = formatHashrate(poolData.hashrate_5m);
    const sps_5m = fmt2t(poolData.sps_5m);
    const merged = {...poolData, ...systemData, ...bitcoinData, network_difficulty, btc_height, best_ever};

    Object.keys(merged).forEach(key => {
      const el = document.getElementById(key);
      if (el && !el.matches(':hover')) {
        const val = merged[key];
        if (key === 'cpu_usage_percent' || key === 'memory_usage_percent' || key === 'disk_usage_percent') {
          el.textContent = fmt2t(val);
        } else if (key !== 'sps_5m' && key !== 'hashrate_5m') {
          el.textContent = val != null ? val.toLocaleString() : '-';
        }
      }
    });

    document.getElementById('hashrate_5m').textContent = hashrate_5m;
    document.getElementById('sps_5m').textContent = sps_5m;

    const nel = document.getElementById('network_difficulty');
    nel.dataset.full = String(bitcoinData.network_difficulty);
    nel.dataset.formatted = network_difficulty;

    const bel = document.getElementById('best_ever');
    bel.dataset.full = String(poolData.best_ever);
    bel.dataset.formatted = best_ever;
  } catch (e) { console.error('refresh error:', e); }
}
startPolling(refresh);
connectWs();
setupLogToggle();
setupCopyable('network_difficulty');
setupCopyable('best_ever');
</script>
